# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs: 
  telegram: woltsu/telegram@0.0.9

commands: # a reusable command with parameters
  send_message:
    steps:
      - run:
          name: set message
          command: |
            if [ $CIRCLE_NODE_INDEX == 0 ]; then
              echo $CIRCLE_PR_REPONAME
              echo $CIRCLE_PR_NUMBER
              echo $CIRCLE_PR_USERNAME
              echo $CIRCLE_PREVIOUS_BUILD_NUM
              echo $CIRCLE_PROJECT_USERNAME
              echo $CIRCLE_PULL_REQUEST
              echo $CIRCLE_PULL_REQUESTS
              echo $CIRCLE_COMPARE_URL
              export MESSAGE="[$CIRCLE_PROJECT_REPONAME:]\nA [$CIRCLE_JOB]($CIRCLE_BUILD_URL) job has succeeded!"
            else
              export MESSAGE=""
            fi
      - telegram/notify:
          message: $MESSAGE
          parse_mode: Markdown

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  test:
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    docker:
      - image: circleci/openjdk:11.0.3-jdk-stretch
        auth:
          username: mydockerhub-user
          password: $DOCKERHUB_PASSWORD
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run: 
          name: "Run tests"
          command: 
            chmod +x ./gradlew &&
            echo "Young dian shen" &&
            ./gradlew test
      - send_message

          

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  ci:
    jobs:
      - test
